<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理後台登入</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f0f0f0; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .login-form { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.2); width: 300px; text-align: center; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .hidden { display: none; }
        .error { color: red; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script> <!-- 如果用 hash -->
</head>
<body>
    <div class="login-form" id="loginForm">
        <h2>管理員登入</h2>
        <input type="text" id="username" placeholder="使用者名稱" required>
        <input type="password" id="password" placeholder="密碼" required>
        <button onclick="login()">登入</button>
        <p class="error" id="errorMsg"></p>
    </div>

    <div class="login-form hidden" id="editPanel">
        <h2>新增精選作品</h2>
        <input type="text" id="title" placeholder="標題" required>
        <textarea id="description" placeholder="說明文字" required></textarea>
        <input type="file" id="image" accept="image/*" required>
        <button onclick="addWork()">儲存並下載 Markdown</button>
        <button onclick="logout()">登出</button>
    </div>

    <script>
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('errorMsg');

            // 讀取 users.yml
            const response = await fetch('../users.yml'); // 調整路徑
            const yamlText = await response.text();
            const config = jsyaml.load(yamlText);

            const user = config.users.find(u => u.username === username);

            if (!user) {
                errorMsg.textContent = '使用者不存在';
                return;
            }

            // 如果用明文
            // if (user.password !== password) { ... }

            // 如果用 bcrypt hash（推薦）
            const match = await bcrypt.compare(password, user.password_hash);
            if (!match) {
                errorMsg.textContent = '密碼錯誤';
                return;
            }

            // 登入成功
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('editPanel').classList.remove('hidden');
        }

        function addWork() {
            const title = document.getElementById('title').value;
            const desc = document.getElementById('description').value;
            const file = document.getElementById('image').files[0];

            if (!file) return alert('請選照片');

            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result; // base64

                // 產生 markdown 內容（上傳照片到 img/works 手動）
                const slug = title.toLowerCase().replace(/\s+/g, '-');
                const mdContent = `---
title: "${title}"
description: "${desc}"
image: "/img/works/${slug}.jpg"  # 請手動上傳照片並改檔名
date: "${new Date().toISOString()}"
---
`;

                // 下載 markdown 檔
                const blob = new Blob([mdContent], {type: 'text/markdown'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${slug}.md`;
                a.click();

                alert('Markdown 已下載，請上傳到 /works 資料夾，並把照片放 img/works');
            };
            reader.readAsDataURL(file); // 如果想顯示預覽
        }

        function logout() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('editPanel').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }
    </script>
</body>
</html>